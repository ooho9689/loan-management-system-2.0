# 手機租賃管理系統

## 📋 系統概述

這是一個完整的手機租賃管理系統，提供客戶管理、付款追蹤、帳務計算、業務分析等功能。系統支持多種客戶狀態管理，並提供詳細的財務報表和業務洞察。

## 🚀 主要功能

### 客戶管理
- **客戶資料管理**：完整的客戶信息錄入和編輯
- **狀態管理**：支持多種客戶狀態（租賃中、逾期、呆帳、已買回等）
- **智能狀態切換**：呆帳按鈕支持雙向切換（設置呆帳/取消呆帳）
- **付款記錄**：詳細的付款歷史追蹤

### 帳務計算系統
- **自動帳務計算**：基於合約日期和付款週期的自動計算
- **多種狀態支持**：
  - `normal`：正常狀態
  - `overdue`：逾期狀態
  - `locked`：呆帳狀態
  - `buyback`：已買回狀態
  - `completed`：結清狀態

### 業務分析
- **實時儀表板**：業務指標和趨勢分析
- **設備績效**：詳細的設備績效統計
- **風險分析**：逾期風險和回收率分析
- **財務報表**：完整的財務統計和損益分析

## 💰 帳務計算邏輯

### 呆帳狀態處理
當客戶被標記為呆帳時：
- **❌ 不會減價**：系統不會自動減客戶的買賣價金
- **✅ 保持原始價金**：呆帳客戶的買賣價金（`salePrice`）保持不變
- **📊 計算未繳金額**：呆帳金額 = 原始買賣價金 - 已繳金額
- **💹 損益計算**：損益 = 已繳總額 - 原始買賣價金

### 已買回狀態處理
當客戶狀態變更為已買回時：
- **✅ 自動添加付款記錄**：系統會自動添加一筆等於買賣價金的付款記錄
- **📝 付款類型標記**：付款類型為 `buyback`，備註為 "買回價金"

### 帳務計算公式
```javascript
// 應繳金額計算
應繳金額 = 當前期數 × 租金

// 未繳金額計算
未繳金額 = 應繳金額 - 已繳總額

// 呆帳金額計算
呆帳金額 = 原始買賣價金 - 已繳金額

// 損益計算
損益 = 已繳總額 - 原始買賣價金
```

## 🔄 客戶狀態管理

### 狀態切換邏輯
- **租賃中 → 呆帳**：客戶逾期未繳款，標記為呆帳
- **呆帳 → 租賃中**：點擊呆帳按鈕可取消呆帳狀態，恢復為租賃中
- **租賃中 → 已買回**：客戶完成付款，標記為已買回
- **任何狀態 → 已買回**：手動設置為已買回狀態

### 呆帳按鈕智能切換
```javascript
// 按鈕文字動態顯示
${customer.status === 'locked' ? '🔓 取消呆帳' : '🔒 呆帳'}

// 狀態變更邏輯
if (newStatus === 'locked' && customer.status === 'locked') {
  // 如果當前已是呆帳，再次點擊則取消呆帳
  newStatus = 'renting';
  message = '已取消呆帳，客戶狀態改回租賃中';
} else {
  // 設置為呆帳狀態
  message = '狀態更新成功';
}
```

## 📊 監控系統配置

### 環境變量配置

系統監控需要以下環境變量配置：

```env
# 郵件配置
SMTP_HOST=smtp.example.com
SMTP_PORT=465
SMTP_USER=your-email@example.com
SMTP_PASS=your-password
ALERT_EMAIL=admin@example.com

# 釘釘配置
DINGTALK_WEBHOOK=https://oapi.dingtalk.com/robot/send?access_token=your-token

# 監控配置
NODE_ENV=development
LOG_LEVEL=info
LOG_RETENTION_DAYS=30
LOG_MAX_SIZE=20m
LOG_MAX_FILES=14d

# 性能閾值配置
MEMORY_WARNING_THRESHOLD=500
DB_CONNECTION_WARNING_THRESHOLD=10
API_RESPONSE_WARNING_THRESHOLD=1000
API_P95_WARNING_THRESHOLD=500
OVERDUE_LOANS_WARNING_THRESHOLD=100
```

### 監控功能說明

1. **系統狀態監控**
   - 內存使用情況
   - CPU 使用情況
   - 數據庫連接狀態
   - 業務指標監控

2. **性能監控**
   - API 響應時間統計
   - 資源使用趨勢
   - 性能指標告警

3. **日誌管理**
   - 按日期輪轉
   - 自動壓縮
   - 定期清理

4. **告警通知**
   - 郵件通知
   - 釘釘通知
   - 多級告警

### 監控指標說明

1. **系統指標**
   - 內存使用超過 500MB 告警
   - 數據庫連接等待超過 10 個告警
   - CPU 使用率監控

2. **性能指標**
   - API 響應時間超過 1000ms 告警
   - API P95 響應時間超過 500ms 告警
   - 資源使用趨勢分析

3. **業務指標**
   - 逾期貸款數量超過 100 個告警
   - 活躍客戶數監控
   - 待處理付款監控

### 日誌管理說明

1. **日誌類型**
   - error-%DATE%.log：錯誤日誌
   - combined-%DATE%.log：綜合日誌
   - performance-%DATE%.log：性能日誌

2. **日誌配置**
   - 單個文件最大 20MB
   - 保留最近 14 天
   - 自動壓縮歸檔

1. **郵件通知**
   - 需要配置 SMTP 服務器
   - 支持 HTML 格式
   - 包含詳細的錯誤信息

2. **釘釘通知**
   - 需要配置 Webhook
   - 支持 Markdown 格式
   - 實時推送告警

3. **告警級別**
   - ERROR：系統錯誤
   - WARNING：性能警告
   - INFO：一般信息

## 🛠️ 使用說明

### 安裝和配置

1. **安裝依賴**
```bash
npm install
```

2. **配置環境變量**
- 複製 .env.example 為 .env
- 修改配置項

3. **啟動服務**
```bash
npm start
```

### 主要功能使用

1. **客戶管理**
   - 新增客戶：填寫完整客戶信息
   - 編輯客戶：修改客戶資料和狀態
   - 狀態管理：使用智能按鈕切換客戶狀態

2. **付款管理**
   - 新增付款：記錄客戶付款
   - 付款歷史：查看完整的付款記錄
   - 自動計算：系統自動計算應繳金額

3. **業務分析**
   - 儀表板：查看業務概況和趨勢
   - 設備績效：分析設備表現
   - 財務報表：導出詳細的財務數據

4. **監控管理**
   - 系統狀態：查看系統運行狀況
   - 日誌查看：檢查系統日誌
   - 告警設置：配置告警規則

### API 端點

- **客戶管理**：`/api/customers`
- **付款管理**：`/api/payments`
- **業務分析**：`/api/insights`
- **系統監控**：`/api/monitor`

## 📈 業務流程

### 標準租賃流程
1. **客戶簽約** → 錄入客戶資料
2. **定期付款** → 記錄付款記錄
3. **狀態監控** → 自動計算逾期情況
4. **風險管理** → 必要時標記呆帳
5. **完成結清** → 標記為已買回

### 呆帳處理流程
1. **逾期監控** → 系統自動檢測逾期
2. **標記呆帳** → 手動設置呆帳狀態
3. **追蹤管理** → 持續監控呆帳客戶
4. **取消呆帳** → 必要時恢復正常狀態

## 🔧 技術架構

- **後端**：Node.js + Express
- **前端**：原生 JavaScript + HTML/CSS
- **數據存儲**：JSON 文件
- **監控**：自定義監控系統
- **日誌**：Winston 日誌系統

## 📝 更新日誌

### 最新更新
- ✅ 呆帳按鈕智能切換功能
- ✅ 帳務計算邏輯優化
- ✅ 客戶狀態管理改進
- ✅ 監控系統完善
- ✅ 日誌管理優化

### 功能特色
- 🎯 人性化的呆帳狀態切換
- 💰 準確的帳務計算邏輯
- 📊 完整的業務分析功能
- 🔍 詳細的系統監控
- 📈 實時的業務洞察 